<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd">

  <!-- Connection Pooling -->
  <bean id="schemaConnectionInstanceFactory" class="org.smallmind.persistence.orm.sql.pool.DriverManagerConnectionInstanceFactory">
    <constructor-arg index="0" value="${jdbc.driver}"/>
    <constructor-arg index="1" value="${jdbc.url.schema}"/>
    <constructor-arg index="2" value="${jdbc.username}"/>
    <constructor-arg index="3" value="${jdbc.password}"/>
    <property name="validationQuery" value="${jdbc.pool.connect.query}"/>
  </bean>

  <bean id="schemaDBPool" class="org.smallmind.quorum.pool.connection.ConnectionPool" init-method="startup" destroy-method="shutdown">
    <constructor-arg index="0" value="dbPool"/>
    <constructor-arg index="1" ref="schemaConnectionInstanceFactory"/>
    <property name="connectionPoolConfig">
      <bean class="org.smallmind.quorum.pool.connection.ConnectionPoolConfig">
        <property name="testOnAcquire" value="${jdbc.pool.connect.test}"/>
        <property name="initialPoolSize" value="${jdbc.pool.size.min}"/>
        <property name="minPoolSize" value="${jdbc.pool.size.min}"/>
        <property name="maxPoolSize" value="${jdbc.pool.size.max}"/>
        <property name="acquireWaitTimeMillis" value="750"/>
        <property name="connectionTimeoutMillis" value="300"/>
        <property name="maxIdleTimeSeconds" value="300"/>
        <property name="maxLeaseTimeSeconds" value="1800"/>
      </bean>
    </property>
  </bean>

  <bean id="schemaPooledDataSource" class="org.smallmind.persistence.orm.sql.pool.PooledDataSource">
    <constructor-arg index="0" value="schema"/>
    <constructor-arg index="1" ref="schemaDBPool"/>
  </bean>

  <!-- JDO Persistence Manager -->
  <bean id="persistenceManagerFactory" class="org.smallmind.persistence.orm.spring.jdo.LocalPersistenceManagerFactoryBean">
    <property name="dataSource" ref="schemaPooledDataSource"/>
    <property name="properties">
      <props>
        <prop key="javax.jdo.PersistenceManagerFactoryClass">org.datanucleus.jdo.JDOPersistenceManagerFactory</prop>
        <prop key="datanucleus.storeManagerType">rdbms</prop>
      </props>
    </property>
  </bean>

  <bean id="proxySession" class="org.smallmind.persistence.orm.jdo.JDOProxySession">
    <constructor-arg index="0" value="schema"/>
    <constructor-arg index="1" ref="persistenceManagerFactory"/>
    <constructor-arg index="2" value="true"/>
    <constructor-arg index="3" value="true"/>
  </bean>

  <!-- AspectJ Transaction Management -->
  <bean id="transactionManagerAspect" class="org.smallmind.persistence.orm.aop.TransactionalAspect" factory-method="aspectOf"/>

  <bean id="schemaPoolMonitor" class="org.smallmind.quorum.pool.connection.jmx.ConnectionPoolMonitor">
    <constructor-arg index="0" ref="schemaDBPool"/>
    <constructor-arg index="1" value="org.smallmind.quorum.pool.jmx.ConnectionPoolMonitor.test"/>
  </bean>

</beans>